## 동시 요청 - 멀티 쓰레드

처음에 웹 브라우저에서 서버로 요청을 보내면 웹 어플리케이션(WAS) 이 응답을 할것이다.

![이미지](/programming/img/서6.PNG)


그러면 TCP/IP 에 연결이 된다

<br/>

### 서블릿 객체를 누가 호출 하는 건가?

바로 쓰레드가 호출하는 것이다.

![이미지](/programming/img/서7.PNG)


<br/><br/>

## 쓰레드

- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드

- 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행
    - main()메서드를 실행하면 main 이라는 이름의 쓰레드가 실행 된다. (딱 하나!)
- 쓰레드가 없다면 자바 애플리케이션 실행이 불가능
- 쓰레드는 한번에 하나의 코드 라인만 수행
- 동시 처리가 필요하면 쓰레드를 추가로 생성

## 하나의 요청만 있고, 하나의 쓰레드만 사용할 수 있다는 

<br/>

예시를 들어보자

![이미지](/programming/img/서8.PNG)

<br/>

요청이 들어오면, 쓰레드를 할당 한 뒤에 쓰레드를 가지고 !! servlet 코드를 실행 시키는 것이다.

![이미지](/programming/img/서9.PNG)

<br/>

쓰레드를 가지고 응답까지 다 한뒤에, 응답이 되고 나면 쓰레드가 휴식을 취하는 것이다. ㅎㅎ

![이미지](/programming/img/서10.PNG)

<br/><br/>

## 다중 요청들이 있고, 하나의 쓰레드만 사용할 수 있다는 예시를 들어보자

먼저. 요청 1번이 들어왔다.

쓰레드를 사용하여 서블릿을 요청 했다. 

그런데 !! 

<br/>servlet 내부의 코드의 문제로 요청이 지연되고 있는 것이다..



이런 상황에서 

갑자기 요청 2번이 들어 온것이다 !!

쓰레드는 하나 뿐이라서 어쩔 수 없이 기다려야 되는 것이다..

<br/>이렇게 된다면 둘 다 죽게 되는 것이다.



이걸 해결하는 방법은

그냥 쓰레드 하나 생성 하면 되는 것이다. ㅎㅎ

<br/>

### 처음부터 정리하자면, 요청 1번이 들어와서 요청이 지연되고 있는 것이다.

그렇다면 고민 할 필요 없이 쓰레드를 하나 더 생성하는 것이다.

그러고 실행이 끝나면 응답하고 나가면 되는 것이다.

<br/>그리고 요청 2번에 썻던 쓰레드는 날리면 되는 것이다. 

![이미지](/programming/img/서11.PNG)

<br/><br/>

## 요청 마다 쓰레드 생성 - 장단점

단점 설명.

내 pc에 코어가 1개라고 생각해보자. 

그러면 코어 수만큼 돌아갈 건데, 쓰레드가 2개 이다.

<br/>코어가 처리할 때는 한개씩 밖에 처리가 안된다. 그리하여 쓰레드를 1개씩 처리한다. 

하지만 너무 빨라서 동시에 하는것 처럼 느껴 진다.

<br/>그렇다면, 쓰레드에서 다른 쓰레드로 전환 할때 비용이 발생하는데, 이걸 

컨텍스트 스위칭 비용 이라고 한다.

## 단점을 해결하기 위해서 ‘쓰레드 풀’ 이라는 것을 사용한다.

![이미지](/programming/img/서12.PNG)

이름 그대로 ‘풀장 == 수영장’ 같은 느낌이다.

<br/>그 안에서 쓰레드가 수영하고 놀고 있다가, 요청 1번과 요청 2번이 온다.

그러면 이걸 ‘쓰레드 풀’ 한테 요청 하는 것이다. 어떻게?

1번과 2번이 “쓰레드 풀안에서 놀고 있는 쓰레드 주세요!” 말하는 것이다.

<br/>여기서 쓰레드 풀 안에는 쓰레드가 200개 있다고 가정하자.

그러면 두개를 빌려가서 ‘쓰레드 풀’ 에 있던 200개가 → 198개가 되는 것이다.

그러고 작업을 다 끝낸 뒤에 쓰레드를 죽이는 것이 아니고, ‘쓰레드 풀’ 에 반납하는 것이다.

<br/>즉, 정리하면  죽이고 생성하고 하는 것이 아니라, 

‘풀’ 안에 미리 만들어서 넣어 놓고 빌려쓰고, 반납하고 하는 것이다

<br/>

### 그리고 나의 쓰레드 갯수는 200개 인데, 201개의 요청이 들어 왔을때는?

대기(=웨이팅) 하거나 거절 할 수 있다.

<br/>그리고 특정 숫자만큼만 대기하도록 설정 할 수도 있다.

<br/><br/>

## WAS의 멀티 쓰레드 지원 - 핵심

핵심은 WAS에 멀티 쓰레드 지원을 해준다는 것이다.

개발자가 멀티 쓰레드 코드 작성하려고 한다면 머리 터진다...

하지만 WAS가 다 관리 해준다. 

<br/>서블릿 코드 안에 비즈니스 로직만 짜면 되는 것이다.

고객이 10명이 오든 100명이 오든 멀티 쓰레드 관한 부분은 개바자가 설정만 하면 되는 것이다.

<br/>‘쓰레드 풀’ 관리하고 ‘쓰레드 풀’ 생성 해주고 멀티 쓰레드 관련된 코드들은 
전부 WAS가 처리해주는 것이다.

- 멀티 쓰레드에 대한 부분은 WAS가 처리

- 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨
- 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 편리하게 소스 코드를 개발
- 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용


<br/>

>**Reference** <br/>스프링 MVC 1편 - 백엔드 웹 개발 핵심 기술 - https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1
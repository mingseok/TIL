## 요청 매핑 헨들러 어뎁터 구조

그렇다면 HTTP 메세지 컨버터는 스프링 MVC 어디쯤에서 사용되는 걸까?

![이미지](/programming/img/서62.PNG)

<br/>

모든 비밀은 애노테이션 기반의 컨트롤러, 그러니까 @RequestMapping 을 처리하는 

핸들러 어댑터인 RequestMappingHandlerAdapter 
(= 한글로 ‘요청 매핑 헨들러 어뎁터’)에 있다.



### RequestMappingHandlerAdapter 동작 방식

![이미지](/programming/img/서63.PNG)

<br/>

### 정확히는 HandlerMethodArgumentResolver 인데 줄여서 
ArgumentResolver(=인터페이스이다) 라고 부른다

<br/>

## ArgumentResolver (Argument는 즉, 매개변수이다)

- ‘ArgumentResolver’ 는 ‘핸들러’ 에 있는 빨간색, 파랑색 즉, 파라미터로 넘어갈 값을 만들어 주는 역할이다.

- ArgumentResolver 는 매개변수들이 올때 마다 이것들을 처리해주는 기능을 담당한다.
- (아규먼트리졸버)

<br/>

생각해보면, 애노테이션 기반의 컨트롤러는 매우 다양한 파라미터를 사용할 수 있었다.

`HttpServletRequest` , `Model` 은 물론이고, `@RequestParam` , `@ModelAttribute` 같은 애노테이션

그리고 `@RequestBody` , `HttpEntity` 같은 HTTP 메시지를 처리하는 부분까지 매우 큰 유연함을 보여주었다. 

<br/>

이렇게 파라미터를 유연하게 처리할 수 있는 이유가 바로 `ArgumentResolver` 덕분이다.

애노테이션 기반 컨트롤러를 처리하는 `RequestMappingHandlerAdaptor` 는 바로 

이 `ArgumentResolver` 를 호출해서 컨트롤러(핸들러)가 필요로 하는 다양한 파라미터의 값(객체)을 생성한다.

<br/>

그리고 이렇게 파리미터의 값이 모두 준비되면 컨트롤러를 호출하면서 값을 넘겨준다. <br/>(=2번 과정이다.) 즉, 순서는 1번으로 갔다가 생성된 객체를 받고 다시 돌아와 2번으로 가는 것이다. 

<br/>

## 지금까지의 순서로 보자면

1. 처음에 ‘핸들러 어댑터’가 ‘핸들러’ 를 보면서 “파라미터 값으로 빨간색, 파란색이 필요하네?” 
하는 것이다. 

![이미지](/programming/img/서64.PNG)

2. 그러면 ‘핸들러 어댑터’ 가 ‘ArgumentResolver’ 한테 물어본다. 

3. “너 빨간색, 파란색 객체 가져다 줄 수 있어?” 이렇게 물어보는 것이다.
4. 그러면 거기에 맞는 아규먼트리졸버에서 선택이 되는 것이다. 
5. 그리하여 ‘핸들러 어댑터’ 는 ‘아규먼트 리졸버’를 통해서 객체를 받는 것이다.
6. 그리고 ‘핸들러’ 파라미터인 빨간색, 파란색 자리에 쏙 넣어 주는 것이다.

<br/>

### 스프링은 30개가 넘는 ArgumentResolver 를 기본으로 제공한다.

<br/>

### 동작 방식

`ArgumentResolver` 안에 메서드로 추상화 되어 있는 `supportsParameter()` 를 호출해서 해당 

파라미터를 지원하는지 체크하고, 지원하면 `resolveArgument()` 를 호출해서 실제 객체를 생성한다. 

그리고 이렇게 생성된 객체가 컨트롤러 호출 시 넘어가는 것이다.

```java
public interface HandlerMethodArgumentResolver {

boolean supportsParameter(MethodParameter parameter);

@Nullable
Object resolveArgument(MethodParameter parameter, @Nullable
		       ModelAndViewContainer mavContainer,
		       NativeWebRequest webRequest, @Nullable WebDataBinderFactory 
		       binderFactory) throws Exception;
}
```

<br/>

## ReturnValueHandler

ArgumentResolver 랑 비슷하다. !!

어쩔땐 `String` 으로 리턴 할때도 있고, `Model` 로 반환 할때도 있고, `@ResponseBody`에 

객체로 반환 할때도 있다. 즉, 이것저것 반환 타입이 많다 !! 

<br/>이거를 처리해 주는 인터페이스가 ReturnValueHandler 이다.

즉, “얘가 컨버팅 작업을 다 해주는 것이다”

<br/>

### HandlerMethodReturnValueHandler 를 줄여서 ReturnValueHandler 라 부른다.

 ArgumentResolver 와 비슷한데, 이것은 응답 값을 변환하고 처리한다.

<br/>

### 컨트롤러에서 String으로 뷰 이름을 반환해도, 동작하는 이유가 바로 ReturnValueHandler 덕분이다.

스프링은 10여개가 넘는 ReturnValueHandler 를 지원한다.

예) `ModelAndView` , `@ResponseBody` , `HttpEntity` , `String`

<br/>


## 그럼 이전 시간에 배운 ‘HTTP 메세지 컨버터’는 어디에 있는가??

![이미지](/programming/img/서65.PNG)

‘ArgumentResolver’ 는 ‘핸들러’ 에 있는 빨간색, 파랑색 즉, 파라미터로 넘어갈 값을 만들어 주는 역할이다.

<br/>

### 그러면 ‘HTTP 메세지 컨버터’ 를 사용하는 애는 ArgumentResolver 가 사용하게 되는 것이다. 

(=이때도 사용하고 리턴 할때도 사용한다)

HTTP 메시지 컨버터를 사용하는 @RequestBody 도 컨트롤러가 필요로 하는 파라미터(=빨간색, 파란색)의 값에 사용된다. 

<br/>즉, `@RequestBody` 와 `HttpEntity` 것은 ArgumentResolver 도 처리 할 수 있다. 

하지만 이 2개는 ‘HTTP 메시지 컨버터’ 를 사용해서 HTTP 메시지 컨버터 안에 필요한 부분을 가져와 객체를 생성하는 것이다. 

<br/>즉, ArgumentResolver 가 ‘HTTP 메시지 컨버터’ 한테 물어본다. 

“내가 `@RequestBody` 처리 해야 되는데, HTTP 바디에 있는거 꺼내서, 니가 JSON 이든, 뭐든 처리 해줄 수 있어?” 물어 보는 것이다. 

<br/>그러고 된다고 하면 ‘HTTP 메세지 컨버터’ 에서 ‘ArgumentResolver’ 으로 반환 해주고, 
‘핸들러 어댑터’ 로 반환 해준다.

(= 밑에 그림을 참고하면 여기서 순차적으로 0번 부터 시작하여 마지막 까지 돌면서 필요한 것을 가져 오는 것이다.)

![이미지](/programming/img/서66.PNG)

<br/>

## 요청의 경우

`@RequestBody` 를 처리하는 `ArgumentResolver` 가 있고, `HttpEntity` 를 처리하는 `ArgumentResolver` 가 있다. 

이 `ArgumentResolver` 들이 HTTP 메시지 컨버터를 사용해서 필요한 객체를 생성하는 것이다.

<br/>이때, HTTP 메시지 컨버터를 호출 할때는 `read()` 로 하는 것이다. 

왜냐? 값을 읽어야 되니깐 !!

<br/>

### 응답의 경우

`@ResponseBody` 와 `HttpEntity` 를 처리하는 `ReturnValueHandler` 가 있다. 그리고

여기에서 HTTP 메시지 컨버터를 호출해서 응답 결과를 만든다.

이때, HTTP 메시지 컨버터를 호출 할때는 `write()` 로 하는 것이다. 

<br/>왜냐? 값을 써야 되니깐!!

스프링은 이걸 모두 인터페이스로 제공한다. 따라서 필요하면 언제든지 기능을 확장할 수 있다.

`HandlerMethodArgumentResolver`

`HandlerMethodReturnValueHandler`

`HttpMessageConverter`


<br/>

>**Reference** <br/>스프링 MVC 1편 - 백엔드 웹 개발 핵심 기술 - https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1

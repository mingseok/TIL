## 서블릿 필터 - 요청 로그

필터가 정말 문지기 역할을 잘 하는지 확인하기 위해 가장 단순한 필터인, 

모든 요청을 로그로 남기는 필터를 개발하고 적용해보자.

<br/>

LogFilter - 로그 필터

```java
package hello.login.web.filter;

import lombok.extern.slf4j.Slf4j;

import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.util.UUID;

@Slf4j
public class LogFilter implements Filter {

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("log filter init");
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response,
                         FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String requestURI = httpRequest.getRequestURI();
        String uuid = UUID.randomUUID().toString();
        
        try {
            log.info("REQUEST [{}][{}]", uuid, requestURI);
            chain.doFilter(request, response);
        } catch (Exception e) {
            throw e;
        } finally {
            log.info("RESPONSE [{}][{}]", uuid, requestURI);
        }
    }

    @Override
    public void destroy() {
        log.info("log filter destroy");
    }
}
```

고객의 요청이 올때 마다 `doFilter()` 메서드가 먼저 호출 된다.

`chain.doFilter()` : 다음 필터를 호출 해주는 것이다. 없으면 서블릿이 호출된다. 

즉, 서블릿 호출 되고, 컨트롤러 호출 된다. 

<br/>

그러고 끝나면 다시 `chain.doFilter()` 메서드로 돌아온다.

request, response 요청을 한눈에 볼 수 있는 것이다.

<br/>

### 실행 로그

```
hello.login.web.filter.LogFilter: REQUEST [0a2249f2-cc70-4db4-98d1-492ccf5629dd][/items]
hello.login.web.filter.LogFilter: RESPONSE [0a2249f2-cc70-4db4-98d1-492ccf5629dd][/items]
```

- `public class LogFilter implements Filter {}`
    - 필터를 사용하려면 필터 인터페이스를 구현해야 한다.
- `doFilter(ServletRequest request, ServletResponse response, FilterChain chain)`
    - HTTP 요청이 오면 doFilter 가 호출된다.
    - `ServletRequest request` 는 HTTP 요청이 아닌 경우까지 고려해서 만든 인터페이스이다.
        
        HTTP를 사용하면 `HttpServletRequest httpRequest = (HttpServletRequest) request;` 와 
        
        같이 다운 케스팅 하면 된다.
        
- `String uuid = UUID.randomUUID().toString();`
    - HTTP 요청을 구분하기 위해 요청당 임의의 uuid 를 생성해둔다.
- `log.info("REQUEST [{}][{}]", uuid, requestURI);`
    - uuid 와 requestURI 를 출력한다.

- `chain.doFilter(request, response);`
    - 이 부분이 가장 중요하다. 다음 필터가 있으면 필터를 호출하고, 필터가 없으면
        
        서블릿을 호출한다. 만약 이 로직을 호출하지 않으면 다음 단계로 진행되지 않는다.

<br/>        

### WebConfig - 필터 설정

```java
package hello.login;

import hello.login.web.filter.LogFilter;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.servlet.Filter;

@Configuration
public class WebConfig {

    @Bean
    public FilterRegistrationBean logFilter() {

        FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();

        filterRegistrationBean.setFilter(new LogFilter());
        filterRegistrationBean.setOrder(1);
        filterRegistrationBean.addUrlPatterns("/*");
        
        return filterRegistrationBean;
    }
}
```

필터를 등록하는 방법은 여러가지가 있지만, 스프링 부트를 사용한다면 `FilterRegistrationBean` 을 사용해서 등록하면 된다.

- `setFilter(new LogFilter())` : 등록할 필터를 지정한다.
- `setOrder(1)` : 필터는 체인으로 동작한다. 따라서 순서가 필요하다. 낮을 수록 먼저 동작한다.
- `addUrlPatterns("/*")` : 필터를 적용할 URL 패턴을 지정한다. 한번에 여러 패턴을 지정할 수 있다.
    
<br/>    

### 참고

URL 패턴에 대한 룰은 필터도 서블릿과 동일하다. 자세한 내용은 서블릿 URL 패턴으로 검색해보자

<br/>

### 참고

`@ServletComponentScan @WebFilter(filterName = "logFilter", urlPatterns = "/*")` 로

필터 등록이 가능하지만 필터 순서 조절이 안된다. 따라서 `FilterRegistrationBean` 을 사용하자.

<br/>

>**Reference** <br/>스프링 MVC 2편 - 백엔드 웹 개발 활용 기술 - https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-2
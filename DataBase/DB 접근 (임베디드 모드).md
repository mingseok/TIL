## DB 접근 (임베디드 모드)

<br/>

테스트 케이스를 실행하기 위해 별도의 DB를 설치하고, 운영하는 것은 번잡한 작업이다. 

단순히 테스트를 검증할 용도로만 사용하기 때문에 테스트가 끝나면 데이터베이스의 데이터를 모두 삭제해도 된다.

```
테스트가 끝나면 데이터베이스 자체를 제거해도 된다.
```

<br/><br/>

## 임베디드 모드

H2 데이터베이스는 자바로 개발되어 있고, JVM안에서 메모리 모드로 동작하는 특별한 기능을 제공한다. 

그래서 애플리케이션을 실행할 때 H2 데이터베이스도 해당 JVM 메모리에 포함해서 함께 실행할 수 있다.

```
DB를 애플리케이션에 내장해서 함께 실행한다고 해서 임베디드 모드라 한다
```

애플리케이션에서 자바 메모리를 함께 사용하는 라이브러리처럼 동작하는 것이다.

<br/><br/>

## 중요한 데이터베이스 테이블이 없다.

메모리 DB에는 아직 테이블을 만들지 않았다.

```
수동으로 할 수도 있지만, 스프링 부트는 이 문제를 해결할 아주 편리한 기능을 제공해준다.
```

<br/><br/>

## 기본 SQL 스크립트 사용하여 데이터베이스 초기화

SQL 스크립트 파일을 생성하자. `src/test/resources/schema.sql`

![이미지](/programming/img/입문254.PNG)

<br/><br/>

## schema.sql

내용 작성해주기.

```sql
drop table if exists item CASCADE;
create table item
(
    id        bigint generated by default as identity,
    item_name varchar(10),
    price     integer,
    quantity  integer,
    primary key (id)
);
```

이렇게 한다면, 먼저 이 파일을 실행 시키고 테스트 파일로 넘어가는 것이다.

<br/><br/>

## 포인트

결국, 테스트 케이스이기 때문에 실제 DB를 실행 할 필요가 없는 것이다.

그냥 간단한, 메모리 DB를 실행 시켜서 성공 하는지만 확인하고 끝나는 것만 확인하면 되기 때문.

<br/><br/>

## (핵심) 스프링 부트와 임베디드 모드.

스프링 부트는 데이터베이스에 대한 별다른 설정이 없으면 임베디드 데이터베이스를 사용한다.

<br/>

## `ItemServiceApplication.class`

이렇게 빈 등록을 하지 않아도 된다.

즉, 앞으로 주석처리 한 부분처럼 작성하지 않아도 된다는 것이다.

```java
@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ItemServiceApplication.class, args);
    }

/*
    @Bean
    @Profile("test")
    public DataSource dataSource() {
        log.info("메모리 데이터베이스 초기화");
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName("org.h2.Driver");
        dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
        dataSource.setUsername("sa");
        dataSource.setPassword("");
        return dataSource;
    }
 */
}
```

<br/>

### 그리고 test → application.properties 설정 변경

![이미지](/programming/img/입문255.PNG)

<br/>

여기서는 ‘#’ 이 주석이다. (두개를 주석 처리 하기)

```java
spring.profiles.active=test
# spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase
# spring.datasource.username=sa

logging.level.org.springframework.jdbc=debug
```

이렇게 하면 데이터베이스에 접근하는 모든 설정 정보가 사라지게 된다

<br/>

이렇게 별다른 정보가 없으면 스프링 부트는 임베디드 모드로 접근하는 데이터소스( DataSource )를 만들어서 제공한다. 



앞서 `ItemServiceApplication.class` 에서 빈등록으로 만든 코드를 스프링이 대신 만들어 준다고 생각하면 된다.



<br/><br/>

>**Reference** <br/>[스프링 DB 2편 - 데이터 접근 활용 기술](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-db-2/dashboard)


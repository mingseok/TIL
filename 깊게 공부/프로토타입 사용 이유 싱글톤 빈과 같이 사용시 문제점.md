## 프로토타입 사용 이유 / 싱글톤 빈과 같이 사용시 문제점

<br/>

## 프로토타입 사용 이유

사용자의 요청이 있을 때마다 매번 관련 있는 빈을 새로 생성하는 것은 비효율적이기 때문이다.

```java
때로는 빈을 싱글톤이 아닌 하나의 빈으로 "여러개의 객체를 만들어 사용"해야 할 때가 있다.
```

<br/>

프로토타입 빈은 컨테이너에게 빈을 요청할 때마다 매번 새로운 객체를 생성하여 반환해준다.



프로토타입은 싱글톤 타입의 스프링 빈과는 다르게 `빈 생성` → `의존관계 주입` → `초기화`까지만 관여 한다. 

<br/>

그 이후 스프링 빈을 클라이언트에 반환 했다면, 관리하지 않기에 

소멸 메서드 같은 것은 모두 클라이언트에서 관리해야 한다.

```java
"즉, 스프링 컨테이너가 그 주입된 프로토타입 빈을 관리하지 않는다"
```

<br/><br/>

## 프로토타입 빈의 특징 정리

- 스프링 컨테이너에 요청할 때마다 새로 생성된다.

- 스프링 컨테이너는 `빈의 생성`과 `의존관계 주입`, `초기화`만 관여한다.

- 종료 메소드가 호출되지 않는다.

- 프로토타입 빈은 해당 빈을 조회한 클라이언트가 관리해야 한다

<br/><br/>

## 싱글톤 빈에서 프로토타입 빈을 참조하는 경우

이 경우 문제가 발생할 수 있다.

싱글톤 빈의 인스턴스는 단 한번만 생성되고, 

그 때 프로토타입 빈의 주입도 이미 완료 되어 있는 상태이다

<br/>

그렇기 때문에, 싱글톤 빈 안의 프로토타입은 

주입 되고 나서, 인스턴스가 새로 생성되지 않는다는 것이다.

<br/>

이렇게 싱글톤 빈에서 프로토타입 빈을 참조할 때는 

인스턴스가 업데이트 되도록 해야 한다. → 어떻게? proxyMode 설정

<br/><br/>

## 업데이트 문제 해결 - proxyMode 설정

가짜 프록시 클래스를 만들어서 주입 시켜주는 것이다.

Proxy를 쓴다는 것은 대상 빈을 proxy로 감싼다는 것이다.

```java
@Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
public class MyLogger {
```

<br/>

proxyMode 속성은 설정하지 않으면 기본값을 `scopedProxyMode.DEFAULT`이다.

`DEFAULT`는 proxy를 사용하지 않는다는 옵션이고 proxy를 사용하려면 

클래스인 경우 `TARGET_CLASS`, 인터페이스일 경우 `INTERFACES`로 설정한다.

- `scopedProxyMode.DEFAULT` : Proxy를 사용하지 않음

- `scopedProxyMode.TARGET_CLASS` : Proxy를 사용한다 (클래스)

- `scopedProxyMode.INTERFACES` : Proxy를 사용한다 (인터페이스)

```java
"가짜 프록시 객체는 요청이 오면 그제서야 내부에 진짜 빈을 요청하는 것이다."
실제 사용할 시점이 되면, 그때 가져온다
```

<br/><br/>

## 그래서 왜 쓰는데?

프록시 객체 덕분에 클라이언트는 마치 싱글톤 빈을 사용하듯이 편리하게 `request scope`를 사용할 수 있다.

`Provider`를 사용하든, `프록시`를 사용하든 핵심은 진짜 객체 조회를 꼭 필요한 시점까지 지연처리 한다는 점이다.

```java
단지 애노테이션 설정 변경만으로 원본 객체를 프록시 객체로 대체할 수 있다.
```

<br/><br/>

## 웹 스코프의 특징

- 웹 스코프는 웹 환경에서만 동작한다.

- 웹 스코프는 스프링이 해당 스코프의 종료 시점까지 빈을 관리한다.
    
    따라서 종료 메소드가 호출된다.
    

<br/><br/>

## 웹 관련 스코프

- `request:` HTTP 요청 하나가 들어오고, 나갈 때까지 유지되는 스코프이다.
    
    각각의 `HTTP 요청`마다 별도의 빈 인스턴스가 생성되고, 관리된다.
    
    - e.g.) 동시에 여러 HTTP 요청이 오면 정확히 어떤 요청이 남긴 로그인지 구분하기 어렵다.
        
        이럴 때 사용하기 좋은 게 `request scope` 이다.
        
- `session:` 웹 세션이 생성되고 종료될 때까지 유지되는 스코프

- `application:` 웹의 서블릿 컨텍스트와 같은 범위로 유지되는 스코프

```java
- request 스코프
```
## 서브쿼리

서브쿼리는 select 명령에 의한 데이터 질의로, 상부가 아닌 하부의 부수적인 작업을 의미한다.


![이미지](/programming/img/입문354.PNG)

<br/>

서브쿼리는 하부 select 명령으로 괄호로 묶어 지정한다.

서브쿼리는 SQL 명령의 WHERE 구에서 주로 사용한다.

<br/>

WHERE 구는 SELECT, DELETE, UPDATE 구에서 사용 가능한데 


이들 중 어떤 명령에서든 서브쿼리를 사용할 수 있다.

<br><br>

## DELETE의 WHERE 구에서 서브쿼리 사용하기.

### 테이블 확인

```sql
SELECT * FROM sample54;
```

| no | a |
| --- | --- |
| 1 | 100 |
| 2 | 900 |
| 3 | 20 |
| 4 | 80 |


sample54 테이블에서 a 열의 값이 가장 작은 행을 삭제하려 한다.

이 테이블에는 네 개의 행밖에 없으므로 a가 20인 행이 가장 작다는 것을 한눈에 알아볼 수 있다.

하지만, a 열의 값이 가장 작은 행이 어느 것인지 전혀 파악할 수 없는 경우에는 어떻게 해야 될까?

```
아마 먼저 select 명령으로 검색하고자 할것이다.
```


<br><br>

## select 명령으로 a의 최솟값 검색하기.

```sql
SELECT MIN(a) FROM sample54;
```

| MIN(a) |
| --- |
| 20 |

서브쿼리는 DELETE 명령과 SELECT 명령을 결합시켜 한번에 처리하는 것이다.

<br><br>

## 서브쿼리를 사용해 최솟값을 가지는 행 삭제하기.


```sql
DELETE FROM sample54 WHERE a = (SELECT MIN(a) FROM sample54);

SELECT * FROM sample54
```

| no | a |
| --- | --- |
| 1 | 100 |
| 2 | 900 |
| 4 | 80 |

괄호로 둘러싼 서브쿼리 부분을 먼저 실행한 후 DELETE 명령을 실행한다고 생각하면 이해하기 쉽다.

<br><br>

## 스칼라 값

### 패턴 1 : 하나의 값을 반환하는 패턴

```sql
SELECT MIN(a) FROM sample54;
```

| MIN(a) |
| --- |
| 80 |

<br>


여기서 패턴1은 다른 명칭이 있다.

이는 다른 패턴과 달리 하나의 값을 반환하기 때문이다.

`단일 값` 으로도 통용되지만 데이터베이스 업계에서는 `스칼라 값` 이라 불리는 경우가 많으므로 기억해 둬야 된다.

```
SELECT 명령이 하나의 값만 반환하는 것을 ‘스칼라 값을 반환한다’ 라고 한다.

스칼라 값을 반환하는 서브쿼리를 특별히 ‘스칼라 서븐쿼리’ 라 부르기도 한다.
```




<br><br>

## SELECT 구에서 서브쿼리 사용하기

단, 문법적으로는 문제없지만 실행하면 에러가 발생하는 경우가 자주 있다.

<br>

이는 스칼라 값의 반환여부에 따라 생기는 현상으로, 

서브쿼리를 사용할 때는 스칼라 서브쿼리로 되어 있는지 확인해야 한다.

<br>

### SELECT 구에서 서브쿼리를 지정할 때는 스칼라 서브쿼리가 필요하다.


```sql
SELECT
   (SELECT COUNT(*) FROM sample51) AS sq1,
   (SELECT COUNT(*) FROM sample54) AS sq2;
```



| sq1 | sq2 |
| --- | --- |
| 5 | 3 |

<br>

주의할 점은, 서브쿼리가 아닌 상부의 SELECT 명령에는 FROM 구가 없다는 것이다.

`MySQL` 등에서는 실제로 FROM 구를 생략할 수 있다. 

하지만 `Oracle` 등 전통적인 데이터베이스 제품에서는 `FROM` 구를 생략 할 수 있다.


```
오라클의 경우는 FROM구를 생략할 수 없다. 하지만, FROM DUAL을 지정하면 실행 할 수 있다.
```

<br><br>

## SET 구에서 서브쿼리 사용하기

update 의 set 구에서도 서브쿼리를 사용할 수 있다.

```sql
update sample54 set a = (select MAX(a) from smaple54);
```

실질적으로는 별로 쓰이지 않는 update 명령이다.


<br><br>

## FROM 구에서 서브쿼리 사용하기.



```sql
SELECT * FROM (SELECT * FROM sample54) sq;
```

| no | a |
| --- | --- |
| 1 | 100 |
| 2 | 900 |
| 4 | 80 |

SELECT 명령 안에 SELECT 명령이 들어있는 듯 보인다.

```
이를 ‘네스티드 구조’ 또는 ‘중첩구조’나 ‘내포구조’라 부른다.
```

<br/>


3장에서 설명했듯 `SELECT` 구에서는 열이나 식에 별명을 붙일 수 있다.

마찬가지로 FROM 구에서는 테이블이나 서브쿼리에 별명을 붙일 수 있다.

<br/>

별명을 붙이는 것으로 비로소 서브쿼리의 이름을 지정한다.

‘AS’ 키워드를 사용하여 지정한다.

```
(Oracle에서는 AS를 붙이면 에러가 발생한다. → Oracle에서는 AS를 붙이지 않는다.)
```

<br><br>

### FROM 구에서 서브쿼리 사용하기(AS로 지정)

```sql
SELECT * FROM (SELECT * FROM sample54) AS sq;
```

| no | a |
| --- | --- |
| 1 | 100 |
| 2 | 900 |
| 4 | 80 |



<br/><br/>

>**Reference** <br/> SQL 첫걸음 : 아사이 아츠시 지음, 박준용 옮김, 한빛미디어
